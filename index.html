<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8ab4f8;
            --primary-dark: #7ba3e6;
            --secondary-color: #81c995;
            --secondary-dark: #72b586;
            --danger-color: #f28b82;
            --danger-dark: #e37b72;
            --bg-dark: #121212;
            --bg-darker: #0a0a0a;
            --bg-card: #1e1e1e;
            --text-primary: #e1e1e1;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .chat-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chat-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-color);
        }

        .tab-bar {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--bg-darker);
            cursor: pointer;
            transition: background 0.3s;
        }

        .tab.active {
            background: var(--primary-color);
            color: #202124;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .controls-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-button {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--bg-darker);
            color: var(--text-primary);
        }
		
		#speakToJapaneseBtn {
			width: auto;
			height: auto;
			padding: 10px 16px;
			border-radius: var(--border-radius);
			font-size: 14px;
		}

        .btn-primary {
            background-color: var(--primary-color);
            color: #202124;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: #202124;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: #202124;
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            opacity: 0.5;
            color: var(--text-secondary);
        }

        .text-area {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
            background-color: var(--bg-darker);
            color: var(--text-primary);
        }

        .text-area:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(138, 180, 248, 0.2);
        }

        .text-area::placeholder {
            color: var(--text-secondary);
        }

        .result-box {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-darker);
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .translation-box {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-darker);
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .status {
            padding: 12px 15px;
            background-color: var(--bg-darker);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .status i {
            color: var(--primary-color);
        }

        .loading {
            padding: 15px;
            background-color: var(--bg-darker);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 1px solid var(--border-color);
        }

        .loading.hidden {
            display: none;
        }

        .loading span {
            color: var(--text-primary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .suggestions {
            margin-top: 10px;
            color: var(--text-primary);
        }

        .suggestions-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .suggestions ul {
            padding-left: 20px;
            margin-top: 8px;
        }

        .suggestions li {
            margin-bottom: 8px;
            line-height: 1.5;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .suggestions li:hover {
            color: var(--primary-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border-color);
        }

        .modal-content h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .modal-content label {
            display: block;
            margin: 10px 0 5px;
            color: var(--text-primary);
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-darker);
            color: var(--text-primary);
        }

        .modal-content button {
            margin-top: 15px;
            padding: 10px;
            width: 100%;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 600px) {
            .chat-container {
                border-radius: 0;
                max-width: 100%;
                height: 100vh;
                padding: 15px;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .controls-group {
                justify-content: space-between;
            }

            .text-area {
                min-height: 120px;
            }
			
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">
                <i class="fas fa-comments"></i> Con Cái
            </div>
            <button id="personalInfoBtn" class="icon-button btn-secondary" title="Cập nhật thông tin cá nhân">
                <i class="fas fa-user"></i>
            </button>
        </div>

        <div class="tab-bar">
            <div class="tab active" data-lang="vi-VN">Tiếng Việt</div>
            <div class="tab" data-lang="ja-JP">Tiếng Nhật</div>
        </div>

        <div class="toolbar">
            <div class="controls-group">
                <button id="micBtn" class="icon-button btn-primary" title="Bắt đầu ghi âm">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="suggestBtn" class="icon-button btn-primary" title="Có phải bạn muốn nói là:" disabled>
                    <i class="fas fa-lightbulb"></i>
                </button>
                <button id="speakBtn" class="icon-button btn-primary" title="Phát âm thanh" disabled>
                    <i class="fas fa-volume-up"></i>
                </button>
                <button id="speakToJapaneseBtn" class="icon-button btn-primary" title="Nói cho người Nhật nghe">
                    <i class="fas fa-bullhorn"></i> Nói cho người Nhật nghe
                </button>
            </div>

            <div class="controls-group">
                <button id="saveBtn" class="icon-button btn-secondary" title="Lưu vào lịch sử" disabled>
                    <i class="fas fa-save"></i>
                </button>
                <button id="clearBtn" class="icon-button btn-danger" title="Xóa tất cả">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <div class="status" id="status">
            <i class="fas fa-info-circle"></i>
            <span>Nhấn nút microphone và nói...</span>
        </div>

        <textarea id="editableText" class="text-area" placeholder="Tin nhắn của bạn sẽ xuất hiện ở đây..."></textarea>

        <div id="translation" class="translation-box hidden">
            <div class="message" id="translation-text"></div>
        </div>

        <div id="result" class="result-box hidden">
            <div class="message" id="message-text"></div>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <span>Đang xử lý...</span>
        </div>

        <div id="corrections" class="suggestions hidden">
            <div class="suggestions-title">
                <i class="fas fa-lightbulb"></i>
                <span id="suggestions-title-text">Có phải bạn muốn nói là:</span>
            </div>
            <div id="suggestions"></div>
        </div>
    </div>

    <div id="personalInfoModal" class="modal">
        <div class="modal-content">
            <h2>Thông tin cá nhân</h2>
            <label for="daughterName">Tên con gái (VD: Vy):</label>
            <input type="text" id="daughterName" placeholder="Nhập tên con gái">
            <label for="sonInLawName">Tên con rể (VD: Ryo):</label>
            <input type="text" id="sonInLawName" placeholder="Nhập tên con rể">
            <button id="savePersonalInfo" class="btn-primary">Lưu</button>
            <button id="closeModal" class="btn-danger">Đóng</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const elements = {
                micBtn: document.getElementById('micBtn'),
                suggestBtn: document.getElementById('suggestBtn'),
                speakBtn: document.getElementById('speakBtn'),
                speakToJapaneseBtn: document.getElementById('speakToJapaneseBtn'),
                saveBtn: document.getElementById('saveBtn'),
                clearBtn: document.getElementById('clearBtn'),
                personalInfoBtn: document.getElementById('personalInfoBtn'),
                personalInfoModal: document.getElementById('personalInfoModal'),
                daughterName: document.getElementById('daughterName'),
                sonInLawName: document.getElementById('sonInLawName'),
                savePersonalInfo: document.getElementById('savePersonalInfo'),
                closeModal: document.getElementById('closeModal'),
                tabs: document.querySelectorAll('.tab'),
                messageText: document.getElementById('message-text'),
                translationText: document.getElementById('translation-text'),
                editableText: document.getElementById('editableText'),
                status: document.getElementById('status'),
                suggestions: document.getElementById('suggestions'),
                suggestionsTitle: document.getElementById('suggestions-title-text'),
                loading: document.getElementById('loading'),
                resultBox: document.getElementById('result'),
                translationBox: document.getElementById('translation'),
                correctionsBox: document.getElementById('corrections')
            };

            const GEMINI_API_KEY = "AIzaSyDjgTk4uZQUCpFH5Zt8ZgP2CW-jhmkLv8o";
            let recognition = null;
            let isRecording = false;
            let currentLang = 'vi-VN';

            // Pregnancy-related suggestions
            const pregnancySuggestions = {
                maternity_care: [
                    {
                        vi: "Vy có cần thêm thực phẩm bổ sung như sắt hoặc canxi không?",
                        ja: "ビーさんは鉄分やカルシウムなどのサプリメントが必要ですか？"
                    },
                    {
                        vi: "Ryo, anh có thể giúp Vy đi khám thai định kỳ không?",
                        ja: "リョウさん、ビーさんの定期検診に付き添ってあげられますか？"
                    },
                    {
                        vi: "Chúng ta nên chuẩn bị gì cho Vy trước khi sinh?",
                        ja: "ビーさんの出産前に何を準備すべきですか？"
                    }
                ],
                postpartum: [
                    {
                        vi: "Vy cần nghỉ ngơi bao lâu sau khi sinh?",
                        ja: "ビーさんは出産後どのくらい休息が必要ですか？"
                    },
                    {
                        vi: "Ryo, anh có thể giúp Vy với việc chăm sóc em bé ban đêm không?",
                        ja: "リョウさん、夜の赤ちゃんの世話をビーさんと一緒にできますか？"
                    },
                    {
                        vi: "Chúng ta nên làm gì để Vy phục hồi sức khỏe sau sinh?",
                        ja: "ビーさんの産後の回復のために何をすべきですか？"
                    }
                ],
                baby_health: [
                    {
                        vi: "Em bé của Vy và Ryo cần tiêm phòng những gì?",
                        ja: "ビーさんとリョウさんの赤ちゃんにはどんな予防接種が必要ですか？"
                    },
                    {
                        vi: "Làm sao để biết em bé của Vy có khỏe mạnh không?",
                        ja: "ビーさんの赤ちゃんが健康かどうかをどうやって確認しますか？"
                    },
                    {
                        vi: "Ryo, anh có muốn học cách tắm cho em bé không?",
                        ja: "リョウさん、赤ちゃんの沐浴の仕方を学びたいですか？"
                    }
                ],
                baby_clothing: [
                    {
                        vi: "Chúng ta nên mua quần áo size nào cho con của Vy và Ryo?",
                        ja: "ビーさんとリョウさんの赤ちゃんにはどのサイズの服を買えばいいですか？"
                    },
                    {
                        vi: "Ryo, anh thích quần áo kiểu Nhật hay Việt cho em bé?",
                        ja: "リョウさん、赤ちゃんの服は日本風とベトナム風、どちらがいいですか？"
                    },
                    {
                        vi: "Quần áo cho em bé của Vy nên chọn chất liệu gì để thoải mái?",
                        ja: "ビーさんの赤ちゃんの服はどんな素材が快適ですか？"
                    }
                ]
            };

            // Load personal info from localStorage
            let personalInfo = JSON.parse(localStorage.getItem('personalInfo') || '{}');
            if (!personalInfo.daughterName) personalInfo.daughterName = 'Vy';
            if (!personalInfo.sonInLawName) personalInfo.sonInLawName = 'Ryo';

            // Personalize suggestions
            function personalizeSuggestions(suggestions) {
                return suggestions.map(suggestion => ({
                    vi: suggestion.vi.replace('Vy', personalInfo.daughterName).replace('Ryo', personalInfo.sonInLawName),
                    ja: suggestion.ja.replace('ビー', personalInfo.daughterName).replace('リョウ', personalInfo.sonInLawName)
                }));
            }

            // Toggle action buttons
            function toggleActionButtons(enabled) {
                elements.suggestBtn.disabled = !enabled;
                elements.speakBtn.disabled = !enabled;
                elements.speakToJapaneseBtn.disabled = !enabled;
                elements.saveBtn.disabled = !enabled;
            }

            // Call Gemini API
            async function fetchFromGemini(promptText) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'Yêu cầu API thất bại');
                    }

                    return response.json();
                } catch (error) {
                    console.error('Lỗi Gemini API:', error);
                    elements.status.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Lỗi API: ${error.message}</span>`;
                    throw error;
                }
            }

            // Translate text to Japanese
            async function translateToJapanese(text) {
                if (!text || text.trim() === '') return '';
                text = text.replace(/\bVy\b/g, 'ヴィちゃん');
                const promptText = `
                    Dịch câu tiếng Việt sau sang tiếng Nhật: "${text}"
                    Trả lời chỉ với bản dịch tiếng Nhật, không thêm giải thích hoặc định dạng khác.
                `;
                const response = await fetchFromGemini(promptText);
                return response.candidates[0].content.parts[0].text.trim();
            }

            // Get improved text and suggestions
            async function getImprovedTextAndSuggestions(text, language) {
                const promptText = `
                    Bạn là một trợ lý trò chuyện. Phân tích câu nói sau (${language === 'ja-JP' ? 'tiếng Nhật' : 'tiếng Việt'}) và đề xuất 2-3 cách diễn đạt tự nhiên hơn, phù hợp để trò chuyện với người nước ngoài. 
                    Câu nói: "${text}"
                    Tất cả câu đã cải thiện và gợi ý phải được trả về bằng tiếng Việt, bất kể ngôn ngữ đầu vào. 
                    Nếu câu đầu vào là tiếng Nhật, hãy dịch sang tiếng Việt trước khi cải thiện và tạo gợi ý.
                    Trả lời theo định dạng JSON:
                    {
                      "corrected_text": "câu đã cải thiện bằng tiếng Việt",
                      "suggestions": ["gợi ý 1 bằng tiếng Việt", "gợi ý 2 bằng tiếng Việt", "gợi ý 3 bằng tiếng Việt"]
                    }
                `;
                try {
                    const response = await fetchFromGemini(promptText);
                    const responseText = response.candidates[0].content.parts[0].text;
                    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('Phản hồi từ Gemini không chứa JSON hợp lệ');
                    }
                    return JSON.parse(jsonMatch[0]);
                } catch (error) {
                    console.error('Lỗi phân tích JSON:', error);
                    elements.status.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Lỗi xử lý gợi ý: ${error.message}</span>`;
                    return { corrected_text: text, suggestions: [] };
                }
            }

            // Improved language detection for Vietnamese
            function isVietnamese(text) {
                const vietnameseRegex = /[àáảãạăắằẳẵặâấầẩẫậèéẻẽẹêếềểễệìíỉĩịòóỏõọôốồổỗộơớờởỡợùúủũụưứừửữựỳýỷỹỵ]/i;
                if (vietnameseRegex.test(text)) return true;

                const commonVietnameseWords = [
                    'toi', 'ban', 'la', 'cua', 'di', 've', 'va', 'voi', 'cho', 'tu',
                    'den', 'trong', 'ngoai', 'len', 'xuong', 'giua', 'tai', 'nho', 'lon', 'rat'
                ];
                const words = text.toLowerCase().split(/\s+/);
                return words.some(word => commonVietnameseWords.includes(word)) || text.length > 5;
            }

            // Display translation
            async function displayTranslation(text) {
                if (!text || text.trim() === '' || currentLang === 'ja-JP') {
                    elements.translationBox.classList.add('hidden');
                    return;
                }

                elements.loading.classList.remove('hidden');
                try {
                    const translation = await translateToJapanese(text);
                    elements.translationText.textContent = translation;
                    elements.translationBox.classList.remove('hidden');
                } catch (error) {
                    elements.status.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Lỗi dịch: ${error.message}</span>`;
                    elements.translationBox.classList.add('hidden');
                } finally {
                    elements.loading.classList.add('hidden');
                }
            }

            // Text-to-speech
            function speakText() {
                const text = currentLang === 'vi-VN'
                    ? elements.translationText.textContent.trim()
                    : elements.editableText.value.trim();
                if (!text) {
                    elements.status.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Không có văn bản để phát âm</span>';
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = currentLang === 'vi-VN' ? 'ja-JP' : currentLang;
                utterance.rate = 1;
                utterance.pitch = 1;
                speechSynthesis.cancel();
                speechSynthesis.speak(utterance);

                elements.status.innerHTML = '<i class="fas fa-volume-up"></i><span>Đang phát âm...</span>';
                utterance.onend = () => {
                    elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Sẵn sàng</span>';
                };
            }

            // Display suggestions
            function displaySuggestions(suggestions, isPregnancyRelated = false) {
                elements.suggestionsTitle.textContent = currentLang === 'ja-JP'
                    ? isPregnancyRelated ? 'Gợi ý liên quan đến thai sản:' : 'Có thể anh ấy muốn nói là:'
                    : isPregnancyRelated ? 'Gợi ý liên quan đến thai sản:' : 'Có phải bạn muốn nói là:';

                let displaySuggestions;
                if (isPregnancyRelated) {
                    displaySuggestions = suggestions.map(s => currentLang === 'vi-VN' ? s.vi : s.ja);
                } else {
                    displaySuggestions = suggestions.filter(s => isVietnamese(s));
                }

                if (displaySuggestions.length === 0 && suggestions.length > 0 && !isPregnancyRelated) {
                    elements.status.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Gợi ý không phải tiếng Việt, vui lòng thử lại.</span>';
                    elements.suggestions.innerHTML = '<p>Không có gợi ý hợp lệ.</p>';
                } else {
                    elements.suggestions.innerHTML = displaySuggestions.length === 0
                        ? '<p>Không có gợi ý nào.</p>'
                        : `<ul>${displaySuggestions.map(s => `<li>${s}</li>`).join('')}</ul>`;
                }

                if (elements.correctionsBox) {
                    elements.correctionsBox.classList.toggle('hidden', displaySuggestions.length === 0);
                } else {
                    console.warn('Phần tử correctionsBox không tồn tại');
                }

                elements.suggestions.querySelectorAll('li').forEach(li => {
                    li.addEventListener('click', () => {
                        elements.editableText.value = li.textContent;
                        toggleActionButtons(true);
                        displayTranslation(li.textContent);
                    });
                });
            }

            // Suggest improved expressions
            async function suggestImprovedExpression() {
                const text = elements.editableText.value.trim();
                if (!text) {
                    const allSuggestions = Object.values(pregnancySuggestions).flat();
                    const personalizedSuggestions = personalizeSuggestions(allSuggestions);
                    displaySuggestions(personalizedSuggestions, true);
                    return;
                }

                elements.loading.classList.remove('hidden');
                elements.suggestBtn.disabled = true;

                try {
                    const result = await getImprovedTextAndSuggestions(text, currentLang);
                    if (!isVietnamese(result.corrected_text)) {
                        elements.status.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Câu cải thiện không phải tiếng Việt, vui lòng thử lại.</span>';
                        return;
                    }
                    elements.editableText.value = result.corrected_text || text;
                    displaySuggestions(result.suggestions || [], false);
                    await displayTranslation(result.corrected_text);
                } catch (error) {
                    elements.status.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Lỗi: ${error.message}</span>`;
                } finally {
                    elements.loading.classList.add('hidden');
                    elements.suggestBtn.disabled = false;
                }
            }

            // Clear all content
            function clearAll() {
                elements.editableText.value = '';
                elements.messageText.textContent = '';
                elements.translationText.textContent = '';
                elements.suggestions.innerHTML = '';
                elements.resultBox.classList.add('hidden');
                elements.translationBox.classList.add('hidden');
                elements.correctionsBox.classList.add('hidden');
                toggleActionButtons(false);
                elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Sẵn sàng</span>';
            }

            // Setup Web Speech API
            function setupRecognition() {
                if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
                    elements.status.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Trình duyệt không hỗ trợ nhận diện giọng nói. Vui lòng sử dụng Google Chrome.</span>';
                    elements.micBtn.disabled = true;
                    return;
                }

                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = currentLang;
                recognition.interimResults = true;
                recognition.continuous = true;
                recognition.maxAlternatives = 1;

                recognition.onresult = async event => {
                    const result = event.results[event.results.length - 1];
                    const transcript = result[0].transcript;

                    if (result.isFinal) {
                        const currentText = elements.editableText.value.trim();
                        elements.editableText.value = currentText ? `${currentText} ${transcript.trim()}` : transcript.trim();
                        elements.messageText.textContent = '';
                        elements.resultBox.classList.add('hidden');
                        toggleActionButtons(true);
                        await displayTranslation(elements.editableText.value);
                    } else {
                        elements.messageText.textContent = transcript;
                        elements.resultBox.classList.remove('hidden');
                    }
                };

                recognition.onstart = () => {
                    isRecording = true;
                    elements.status.innerHTML = '<i class="fas fa-microphone"></i><span>Đang nghe... Nói điều gì đó</span>';
                    elements.micBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    elements.micBtn.title = 'Dừng ghi âm';
                    elements.micBtn.classList.replace('btn-primary', 'btn-danger');
                };

                recognition.onend = () => {
                    isRecording = false;
                    elements.status.innerHTML = '<i class="fas fa-check-circle"></i><span>Đã dừng ghi âm</span>';
                    elements.micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    elements.micBtn.title = 'Bắt đầu ghi âm';
                    elements.micBtn.classList.replace('btn-danger', 'btn-primary');
                    toggleActionButtons(!!elements.editableText.value.trim());
                };

                recognition.onerror = event => {
                    isRecording = false;
                    elements.micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    elements.micBtn.title = 'Bắt đầu ghi âm';
                    elements.micBtn.classList.replace('btn-danger', 'btn-primary');
                    const errorMessages = {
                        'no-speech': 'Không phát hiện giọng nói',
                        'audio-capture': 'Không thể truy cập microphone',
                        'not-allowed': 'Microphone bị chặn, vui lòng cấp quyền',
                        default: `Lỗi: ${event.error}`
                    };
                    elements.status.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${errorMessages[event.error] || errorMessages.default}</span>`;
                };
            }

            // Handle personal info modal
            elements.personalInfoBtn.addEventListener('click', () => {
                elements.daughterName.value = personalInfo.daughterName;
                elements.sonInLawName.value = personalInfo.sonInLawName;
                elements.personalInfoModal.style.display = 'flex';
            });

            elements.savePersonalInfo.addEventListener('click', () => {
                personalInfo.daughterName = elements.daughterName.value.trim() || 'Vy';
                personalInfo.sonInLawName = elements.sonInLawName.value.trim() || 'Ryo';
                localStorage.setItem('personalInfo', JSON.stringify(personalInfo));
                elements.personalInfoModal.style.display = 'none';
                elements.status.innerHTML = '<i class="fas fa-check-circle"></i><span>Đã lưu thông tin cá nhân!</span>';
                setTimeout(() => {
                    elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Sẵn sàng</span>';
                }, 2000);
            });

            elements.closeModal.addEventListener('click', () => {
                elements.personalInfoModal.style.display = 'none';
            });

            // Handle tab switching
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    elements.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentLang = tab.dataset.lang;
                    elements.editableText.placeholder = currentLang === 'vi-VN' ? 'Tin nhắn của bạn sẽ xuất hiện ở đây...' : 'メッセージはここに表示されます...';
                    if (recognition) {
                        const wasRecording = isRecording;
                        recognition.stop();
                        recognition.lang = currentLang;
                        if (wasRecording) {
                            setTimeout(() => {
                                try {
                                    recognition.start();
                                } catch (err) {
                                    elements.status.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>Lỗi khởi động ghi âm: ${err.message}</span>`;
                                }
                            }, 100);
                        }
                    }
                    elements.status.innerHTML = `<i class="fas fa-info-circle"></i><span>Đã chuyển sang ${currentLang === 'vi-VN' ? 'Tiếng Việt' : 'Tiếng Nhật'}</span>`;
                    displayTranslation(elements.editableText.value);
                });
            });

            // Event listeners
            elements.editableText.addEventListener('input', () => {
                toggleActionButtons(!!elements.editableText.value.trim());
                displayTranslation(elements.editableText.value);
            });

            elements.micBtn.addEventListener('click', () => {
                if (!recognition) setupRecognition();
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        if (!isRecording) recognition.start();
                        else recognition.stop();
                    })
                    .catch(err => {
                        elements.status.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>Không thể truy cập microphone: ${err.message}</span>`;
                    });
            });

            elements.suggestBtn.addEventListener('click', suggestImprovedExpression);

            elements.speakBtn.addEventListener('click', speakText);

            elements.speakToJapaneseBtn.addEventListener('click', speakText);

            elements.saveBtn.addEventListener('click', () => {
                const textToSave = elements.editableText.value.trim();
                if (!textToSave) return;
                const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                history.push({
                    text: textToSave,
                    language: currentLang,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('chatHistory', JSON.stringify(history));
                elements.status.innerHTML = '<i class="fas fa-check-circle"></i><span>Đã lưu!</span>';
                setTimeout(() => {
                    elements.status.innerHTML = '<i class="fas fa-info-circle"></i><span>Sẵn sàng</span>';
                }, 2000);
            });

            elements.clearBtn.addEventListener('click', clearAll);

            // Initialize
            setupRecognition();
        });
    </script>
</body>
</html>
